import React, { useState, useEffect } from "react";
import {
  Box,
  Container,
  Stack,
  Paper,
  Typography,
  Button,
  useTheme,
  useMediaQuery,
  Chip,
} from "@mui/material";
import { keyframes } from "@emotion/react";
import {
  PauseRounded,
  SettingsRounded,
  PlayArrowRounded,
  ContentCopy as CopyIcon,
} from "@mui/icons-material";
import { GAME_STATES } from "./constants";
import { useGameLogic } from "./hooks/useGameLogic";
import { getControlsFromStorage } from "./utils/controlsUtils";
import WelcomeScreen from "./components/WelcomeScreen";
import GameBoard from "./components/GameBoard";
import GameInfo from "./components/GameInfo";
import { BotControlPanel } from "./components/BotControlPanel";
import SettingsDialog from "./components/SettingsDialog";
import gameService from "./services/gameService";

const pulseAnimation = keyframes`
  0%, 100% { opacity: 0.8; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.05); }
`;

const App: React.FC = () => {
  const [settingsOpen, setSettingsOpen] = useState(false);
  const [roomCode, setRoomCode] = useState<string | null>(null);
  const { gameBoard, playerName, startGame, createRoom, pauseGame, bot } =
    useGameLogic(settingsOpen);
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));

  // Update controls when settings dialog closes
  useEffect(() => {
    if (!settingsOpen) {
      getControlsFromStorage();
    }
  }, [settingsOpen]);

  // Check room code from gameService
  useEffect(() => {
    const checkRoomCode = () => {
      const currentRoomCode = gameService.getRoomCode();
      setRoomCode(currentRoomCode);
    };

    checkRoomCode();
    const interval = setInterval(checkRoomCode, 1000);
    return () => clearInterval(interval);
  }, []);

  const handleSettingsOpen = () => {
    // Pause game when opening settings if game is playing
    if (gameBoard.gameState === GAME_STATES.PLAYING && !gameBoard.isPaused) {
      pauseGame();
    }
    setSettingsOpen(true);
  };

  const handleSettingsClose = () => {
    setSettingsOpen(false);
  };

  const handleJoinRoom = async (playerName: string, roomCode: string) => {
    try {
      // Join room th√¥ng qua gameService
      await gameService.joinRoom(roomCode, playerName);
      console.log(`üö™ Joined room: ${roomCode}`);
    } catch (error) {
      console.error('Failed to join room:', error);
      // C√≥ th·ªÉ hi·ªÉn th·ªã error message ·ªü ƒë√¢y
    }
  };

  const handleCopyRoomCode = async () => {
    if (roomCode) {
      try {
        await navigator.clipboard.writeText(roomCode);
        console.log("Room code copied:", roomCode);
  const handleCopyRoomCode = async () => {
    if (roomCode) {
      try {
        await navigator.clipboard.writeText(roomCode);
        console.log("Room code copied:", roomCode);
      } catch (error) {
        console.error("Failed to copy room code:", error);
      }
    }
  };

  const renderGameContent = () => {
    const { gameState } = gameBoard;

    if (gameState === GAME_STATES.WELCOME) {
      return (
        <WelcomeScreen 
          onCreateRoom={createRoom} 
          onJoinRoom={handleJoinRoom}
          savedPlayerName={playerName} 
        />
      );
    }

    // WAITING, Playing, Paused, or Game Over state - show game layout
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <Stack
          direction={isMobile ? "column" : "row"}
          spacing={4}
          alignItems={isMobile ? "center" : "flex-start"}
          justifyContent="center"
        >
          {/* Left Side: Game Board */}
          <Box position="relative">
            <GameBoard
              grid={gameBoard.grid}
              activePiece={gameBoard.activePiece}
              ghostPiece={gameBoard.ghostPiece}
              clearingRows={gameBoard.clearingRows}
              dropPosition={gameBoard.dropPosition}
              isShaking={gameBoard.isShaking}
            />

            {gameBoard.isPaused && gameState === GAME_STATES.PLAYING && (
              <Box
                position="absolute"
                top={0}
                left={0}
                right={0}
                bottom={0}
                display="flex"
                alignItems="center"
                justifyContent="center"
                sx={{
                  background: "rgba(0, 0, 0, 0.8)",
                  backdropFilter: "blur(8px)",
                  borderRadius: 3,
                  zIndex: 1000,
                }}
              >
                <Paper
                  elevation={8}
                  sx={{
                    p: 4,
                    textAlign: "center",
                    background: "rgba(26, 26, 26, 0.95)",
                    border: "2px solid rgba(255, 170, 0, 0.5)",
                    animation: `${pulseAnimation} 2s ease-in-out infinite`,
                  }}
                >
                  <PauseRounded
                    sx={{
                      fontSize: 48,
                      color: "warning.main",
                      mb: 2,
                    }}
                  />
                  <Typography variant="h4" color="warning.main" gutterBottom>
                    PAUSED
                  </Typography>
                  <Typography variant="body1" color="text.secondary">
                    Press any movement key to resume
                  </Typography>
                </Paper>
              </Box>
            )}

            {gameState === GAME_STATES.GAME_OVER && (
              <Box
                position="absolute"
                top={0}
                left={0}
                right={0}
                bottom={0}
                display="flex"
                alignItems="center"
                justifyContent="center"
                sx={{
                  background: "rgba(0, 0, 0, 0.9)",
                  backdropFilter: "blur(10px)",
                  borderRadius: 3,
                  zIndex: 1000,
                }}
              >
                <Paper
                  elevation={12}
                  sx={{
                    p: 4,
                    textAlign: "center",
                    background: "rgba(26, 26, 26, 0.95)",
                    border: "2px solid rgba(244, 67, 54, 0.5)",
                    animation: `${pulseAnimation} 2s ease-in-out infinite`,
                  }}
                >
                  <Typography
                    variant="h3"
                    color="error.main"
                    gutterBottom
                    sx={{ fontWeight: "bold" }}
                  >
                    GAME OVER
                  </Typography>
                  <Typography variant="h5" color="text.primary" sx={{ mb: 2 }}>
                    Final Score: {gameBoard.score.toLocaleString()}
                  </Typography>
                  <Typography
                    variant="body1"
                    color="text.secondary"
                    sx={{ mb: 3 }}
                  >
                    Lines Cleared: {gameBoard.lines} | Level: {gameBoard.level}
                  </Typography>
                  <Button
                    variant="contained"
                    color="primary"
                    size="large"
                    onClick={() => window.location.reload()}
                    sx={{
                      px: 4,
                      py: 1.5,
                      fontSize: "1.1rem",
                      fontWeight: 600,
                    }}
                  >
                    Play Again
                  </Button>
                </Paper>
              </Box>
            )}
          </Box>

          {/* Middle: Game Info */}
          <GameInfo
            score={gameBoard.score}
            lines={gameBoard.lines}
            level={gameBoard.level}
            nextPiece={gameBoard.nextPiece}
            holdPiece={gameBoard.holdPiece}
            canHold={gameBoard.canHold}
          />

          {/* Right Side: Toolbar */}
          <Stack spacing={3} sx={{ minWidth: { xs: "100%", md: 320 } }}>
            {/* Room Code Panel */}
            {roomCode && (
              <Paper
                elevation={4}
                sx={{
                  p: 3,
                  background: "rgba(26, 26, 26, 0.9)",
                  border: "1px solid rgba(156, 39, 176, 0.3)",
                }}
              >
                <Typography
                  variant="h6"
                  component="h4"
                  textAlign="center"
                  color="secondary.light"
                  gutterBottom
                >
                  üè† Room Code
                </Typography>
                <Box
                  sx={{ display: "flex", alignItems: "center", gap: 1, mb: 2 }}
                >
                  <Chip
                    label={roomCode}
                    color="secondary"
                    sx={{
                      fontSize: "1.2rem",
                      fontWeight: "bold",
                      flexGrow: 1,
                      height: 40,
                    }}
                  />
                  <Button
                    variant="outlined"
                    color="secondary"
                    onClick={handleCopyRoomCode}
                    startIcon={<CopyIcon />}
                    sx={{ minWidth: "auto", px: 2 }}
                  >
                    Copy
                  </Button>
                </Box>
                <Typography
                  variant="body2"
                  color="text.secondary"
                  textAlign="center"
                >
                  Share this code with friends to play together
                </Typography>
                {gameService.isMultiplayer() && (
                  <Chip
                    label="üü¢ Multiplayer Active"
                    color="success"
                    size="small"
                    sx={{ mt: 1, width: "100%" }}
                  />
                )}
              </Paper>
            )}

            {/* Player Info & Start Game */}
            <Paper
              elevation={6}
              sx={{
                p: 3,
                background: "rgba(26, 26, 26, 0.95)",
                border: "1px solid rgba(0, 204, 102, 0.3)",
              }}
            >
              <Typography
                variant="h5"
                component="h3"
                textAlign="center"
                color="success.light"
                gutterBottom
                sx={{ fontWeight: 600 }}
              >
                üëã Hello, {playerName}!
              </Typography>

              {gameState === GAME_STATES.WAITING && (
                <Button
                  variant="contained"
                  color="success"
                  fullWidth
                  size="large"
                  onClick={startGame}
                  startIcon={<PlayArrowRounded />}
                  sx={{
                    py: 2,
                    fontSize: "1.2rem",
                    fontWeight: 600,
                    background: "linear-gradient(45deg, #00c853, #00e676)",
                    "&:hover": {
                      background: "linear-gradient(45deg, #00b248, #00c853)",
                      transform: "translateY(-2px)",
                      boxShadow: "0 8px 25px rgba(0, 200, 83, 0.4)",
                    },
                    transition: "all 0.3s ease-in-out",
                  }}
                >
                  Start Game
                </Button>
              )}

              {(gameState === GAME_STATES.PLAYING ||
                gameState === GAME_STATES.PAUSED) && (
                <Button
                  variant="contained"
                  color={gameBoard.isPaused ? "success" : "warning"}
                  fullWidth
                  size="large"
                  onClick={pauseGame}
                  startIcon={
                    gameBoard.isPaused ? <PlayArrowRounded /> : <PauseRounded />
                  }
                  sx={{
                    py: 2,
                    fontSize: "1.2rem",
                    fontWeight: 600,
                    background: gameBoard.isPaused
                      ? "linear-gradient(45deg, #00c853, #00e676)"
                      : "linear-gradient(45deg, #ff8f00, #ffab00)",
                    "&:hover": {
                      background: gameBoard.isPaused
                        ? "linear-gradient(45deg, #00b248, #00c853)"
                        : "linear-gradient(45deg, #e68900, #ff9500)",
                      transform: "translateY(-2px)",
                      boxShadow: gameBoard.isPaused
                        ? "0 8px 25px rgba(0, 200, 83, 0.4)"
                        : "0 8px 25px rgba(255, 171, 0, 0.4)",
                    },
                    transition: "all 0.3s ease-in-out",
                  }}
                >
                  {gameBoard.isPaused ? "Resume Game" : "Pause Game"}
                </Button>
              )}
            </Paper>

            {/* Settings Button */}
            <Paper
              elevation={4}
              sx={{
                p: 3,
                background: "rgba(26, 26, 26, 0.9)",
                border: "1px solid rgba(255, 170, 0, 0.2)",
              }}
            >
              <Typography
                variant="h6"
                component="h4"
                textAlign="center"
                color="warning.light"
                gutterBottom
              >
                ‚öôÔ∏è Settings
              </Typography>

              <Button
                variant="contained"
                color="warning"
                fullWidth
                onClick={handleSettingsOpen}
                startIcon={<SettingsRounded />}
                sx={{
                  py: 1.5,
                  fontSize: "1rem",
                  fontWeight: 600,
                  background: "linear-gradient(45deg, #ff8f00, #ffab00)",
                  "&:hover": {
                    background: "linear-gradient(45deg, #e68900, #ff9500)",
                    transform: "translateY(-2px)",
                    boxShadow: "0 8px 25px rgba(255, 171, 0, 0.4)",
                  },
                  transition: "all 0.3s ease-in-out",
                }}
              >
                Open Settings
              </Button>
            </Paper>

            {/* Bot Control Panel */}
            {/* {(gameState === GAME_STATES.PLAYING ||
              gameState === GAME_STATES.PAUSED) && (
              <BotControlPanel
                isEnabled={bot.isEnabled}
                difficulty={bot.difficulty}
                onEnabledChange={bot.setEnabled}
                onDifficultyChange={bot.setDifficulty}
                currentMove={bot.currentMove}
              />
            )} */}
          </Stack>
        </Stack>

        {/* Settings Dialog */}
        <SettingsDialog open={settingsOpen} onClose={handleSettingsClose} />
      </Container>
    );
  };

  return (
    <Box
      sx={{
        minHeight: "100vh",
        background:
          "linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%)",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        position: "relative",
        "&::before": {
          content: '""',
          position: "absolute",
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: `
            radial-gradient(circle at 20% 50%, rgba(0, 170, 255, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 80%, rgba(0, 204, 102, 0.1) 0%, transparent 50%)
          `,
          zIndex: -1,
        },
      }}
    >
      {renderGameContent()}
    </Box>
  );
};

export default App;
